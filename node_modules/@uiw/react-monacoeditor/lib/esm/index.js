import _extends from "@babel/runtime/helpers/esm/extends";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import _objectSpread from "@babel/runtime/helpers/esm/objectSpread2";
import _slicedToArray from "@babel/runtime/helpers/esm/slicedToArray";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
import React, { useImperativeHandle, useEffect, useRef, useState } from 'react';
import * as monaco from 'monaco-editor';
import { editor } from 'monaco-editor';

function noop() {}

function MonacoEditor(props, ref) {
  var _props$width = props.width,
      width = _props$width === void 0 ? '100%' : _props$width,
      _props$height = props.height,
      height = _props$height === void 0 ? '100%' : _props$height,
      _props$value = props.value,
      value = _props$value === void 0 ? '' : _props$value,
      _props$theme = props.theme,
      theme = _props$theme === void 0 ? '' : _props$theme,
      _props$language = props.language,
      language = _props$language === void 0 ? 'javascript' : _props$language,
      autoComplete = props.autoComplete,
      _props$options = props.options,
      options = _props$options === void 0 ? {} : _props$options,
      _props$editorDidMount = props.editorDidMount,
      editorDidMount = _props$editorDidMount === void 0 ? noop : _props$editorDidMount,
      _props$onChange = props.onChange,
      onChange = _props$onChange === void 0 ? noop : _props$onChange,
      _props$defaultValue = props.defaultValue,
      defaultValue = _props$defaultValue === void 0 ? '' : _props$defaultValue,
      other = _objectWithoutProperties(props, ["width", "height", "value", "theme", "language", "autoComplete", "options", "editorDidMount", "onChange", "defaultValue"]);

  options.language = language || options.language;
  options.theme = theme || options.theme;

  var _useState = useState(defaultValue),
      _useState2 = _slicedToArray(_useState, 2),
      val = _useState2[0],
      setVal = _useState2[1];

  var container = useRef(null);
  var editor = useRef();
  useImperativeHandle(ref, function () {
    return {
      container: container.current,
      editor: editor.current,
      monaco: monaco
    };
  });
  useEffect(function () {
    if (container.current) {
      editor.current = monaco.editor.create(container.current, _objectSpread({
        value: val,
        language: language
      }, options));

      if (options.theme) {
        monaco.editor.setTheme(options.theme);
      } // After initializing monaco editor


      editorDidMount(editor.current, monaco);
      editor.current.onDidChangeModelContent(function (event) {
        var valueCurrent = editor.current.getValue(); // Always refer to the latest value

        onChange(valueCurrent, event);
      });
    }
  }, []);
  useEffect(function () {
    if (value !== val && editor.current) {
      if (autoComplete) {
        var _editor$current, _editor$current2;

        if (editor !== null && editor !== void 0 && (_editor$current = editor.current) !== null && _editor$current !== void 0 && _editor$current.getModel() && editor !== null && editor !== void 0 && (_editor$current2 = editor.current) !== null && _editor$current2 !== void 0 && _editor$current2.getPosition()) {
          monaco.languages.registerCompletionItemProvider(language, {
            provideCompletionItems: function provideCompletionItems(model, position) {
              return {
                suggestions: autoComplete(model, position)
              };
            }
          });
        }
      }

      setVal(value);
      editor.current.setValue(value);
    }
  }, [value]);
  useEffect(function () {
    if (editor.current) {
      var _model = editor.current.getModel();

      if (_model) {
        monaco.editor.setModelLanguage(_model, props.language || '');
      }
    }
  }, [language]);
  useEffect(function () {
    if (editor.current) {
      var optionsRaw = editor.current.getRawOptions();
      ;
      Object.keys(optionsRaw).forEach(function (keyname) {
        var propsOpt = options[keyname];

        if (optionsRaw[keyname] !== propsOpt && propsOpt !== undefined) {
          editor.current.updateOptions(_defineProperty({}, keyname, propsOpt));
        }
      });
    }
  }, [options]);
  return /*#__PURE__*/React.createElement("div", _extends({}, other, {
    ref: container,
    style: _objectSpread(_objectSpread({}, other.style), {}, {
      width: width,
      height: height
    })
  }));
}

export default /*#__PURE__*/React.forwardRef(MonacoEditor);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC50c3giXSwibmFtZXMiOlsiUmVhY3QiLCJ1c2VJbXBlcmF0aXZlSGFuZGxlIiwidXNlRWZmZWN0IiwidXNlUmVmIiwidXNlU3RhdGUiLCJtb25hY28iLCJlZGl0b3IiLCJub29wIiwiTW9uYWNvRWRpdG9yIiwicHJvcHMiLCJyZWYiLCJ3aWR0aCIsImhlaWdodCIsInZhbHVlIiwidGhlbWUiLCJsYW5ndWFnZSIsImF1dG9Db21wbGV0ZSIsIm9wdGlvbnMiLCJlZGl0b3JEaWRNb3VudCIsIm9uQ2hhbmdlIiwiZGVmYXVsdFZhbHVlIiwib3RoZXIiLCJ2YWwiLCJzZXRWYWwiLCJjb250YWluZXIiLCJjdXJyZW50IiwiY3JlYXRlIiwic2V0VGhlbWUiLCJvbkRpZENoYW5nZU1vZGVsQ29udGVudCIsImV2ZW50IiwidmFsdWVDdXJyZW50IiwiZ2V0VmFsdWUiLCJnZXRNb2RlbCIsImdldFBvc2l0aW9uIiwibGFuZ3VhZ2VzIiwicmVnaXN0ZXJDb21wbGV0aW9uSXRlbVByb3ZpZGVyIiwicHJvdmlkZUNvbXBsZXRpb25JdGVtcyIsIm1vZGVsIiwicG9zaXRpb24iLCJzdWdnZXN0aW9ucyIsInNldFZhbHVlIiwic2V0TW9kZWxMYW5ndWFnZSIsIm9wdGlvbnNSYXciLCJnZXRSYXdPcHRpb25zIiwiT2JqZWN0Iiwia2V5cyIsImZvckVhY2giLCJrZXluYW1lIiwicHJvcHNPcHQiLCJ1bmRlZmluZWQiLCJ1cGRhdGVPcHRpb25zIiwic3R5bGUiLCJmb3J3YXJkUmVmIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU9BLEtBQVAsSUFBZ0JDLG1CQUFoQixFQUFxQ0MsU0FBckMsRUFBZ0RDLE1BQWhELEVBQXdEQyxRQUF4RCxRQUF3RSxPQUF4RTtBQUNBLE9BQU8sS0FBS0MsTUFBWixNQUF3QixlQUF4QjtBQUNBLFNBQVFDLE1BQVIsUUFBZ0MsZUFBaEM7O0FBRUEsU0FBU0MsSUFBVCxHQUFnQixDQUFFOztBQTBEbEIsU0FBU0MsWUFBVCxD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Q2QsUUFBSUksTUFBTSxDQUFDbUIsT0FBWCxFQUFvQjtBQUNsQixVQUFNaUIsVUFBVSxHQUFHcEMsTUFBTSxDQUFDbUIsT0FBUCxDQUFla0IsYUFBZixFQUFuQjtBQUNBO0FBQUVDLE1BQUFBLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZSCxVQUFaLENBQUQsQ0FBNkRJLE9BQTdELENBQXFFLFVBQUNDLE9BQUQsRUFBYTtBQUNqRixZQUFNQyxRQUFRLEdBQUcvQixPQUFPLENBQUM4QixPQUFELENBQXhCOztBQUNBLFlBQUlMLFVBQVUsQ0FBQ0ssT0FBRCxDQUFWLEtBQXdCQyxRQUF4QixJQUFvQ0EsUUFBUSxLQUFLQyxTQUFyRCxFQUFnRTtBQUM5RDNDLFVBQUFBLE1BQU0sQ0FBQ21CLE9BQVAsQ0FBZ0J5QixhQUFoQixxQkFBaUNILE9BQWpDLEVBQTJDQyxRQUEzQztBQUNEO0FBQ0YsT0FMQTtBQU1GO0FBQ0YsR0FWUSxFQVVOLENBQUMvQixPQUFELENBVk0sQ0FBVDtBQVlBLHNCQUFPLHdDQUFTSSxLQUFUO0FBQWdCLElBQUEsR0FBRyxFQUFFRyxTQUFyQjtBQUFnQyxJQUFBLEtBQUssa0NBQU9ILEtBQUssQ0FBQzhCLEtBQWI7QUFBb0J4QyxNQUFBQSxLQUFLLEVBQUxBLEtBQXBCO0FBQTJCQyxNQUFBQSxNQUFNLEVBQU5BO0FBQTNCO0FBQXJDLEtBQVA7QUFDRDs7QUFFRCw0QkFBZVosS0FBSyxDQUFDb0QsVUFBTixDQUF1RDVDLFlBQXZELENBQWYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlSW1wZXJhdGl2ZUhhbmRsZSwgdXNlRWZmZWN0LCB1c2VSZWYsIHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0ICogYXMgbW9uYWNvIGZyb20gJ21vbmFjby1lZGl0b3InO1xuaW1wb3J0IHtlZGl0b3IsIGxhbmd1YWdlc30gZnJvbSAnbW9uYWNvLWVkaXRvcic7XG5cbmZ1bmN0aW9uIG5vb3AoKSB7fVxuXG5leHBvcnQgdHlwZSBJTW9uYWNvRWRpdG9yID0gdHlwZW9mIG1vbmFjbztcbmV4cG9ydCBpbnRlcmZhY2UgTW9uYWNvRWRpdG9yUHJvcHMgZXh0ZW5kcyBPbWl0PFJlYWN0LkhUTUxBdHRyaWJ1dGVzPEhUTUxEaXZFbGVtZW50PiwgJ29uQ2hhbmdlJz57XG4gIC8qKlxuICAgKiB3aWR0aCBvZiBlZGl0b3IuXG4gICAqIERlZmF1bHRzIHRvIGAxMDAlYFxuICAgKi9cbiAgd2lkdGg/OiBudW1iZXIgfCBzdHJpbmc7XG4gIC8qKlxuICAgKiBoZWlnaHQgb2YgZWRpdG9yLlxuICAgKiBEZWZhdWx0cyB0byBgMTAwJWAuXG4gICAqL1xuICBoZWlnaHQ/OiBudW1iZXIgfCBzdHJpbmc7XG4gIC8qKlxuICAgKiB2YWx1ZSBvZiB0aGUgYXV0byBjcmVhdGVkIG1vZGVsIGluIHRoZSBlZGl0b3IuXG4gICAqL1xuICB2YWx1ZT86IHN0cmluZztcbiAgLyoqXG4gICAqIHRoZSBpbml0aWFsIHZhbHVlIG9mIHRoZSBhdXRvIGNyZWF0ZWQgbW9kZWwgaW4gdGhlIGVkaXRvci5cbiAgICovXG4gIGRlZmF1bHRWYWx1ZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBpbml0aWFsIGxhbmd1YWdlIG9mIHRoZSBhdXRvIGNyZWF0ZWQgbW9kZWwgaW4gdGhlIGVkaXRvci5cbiAgICogVG8gbm90IGNyZWF0ZSBhdXRvbWF0aWNhbGx5IGEgbW9kZWwsIHVzZSBgbW9kZWw6IG51bGxgLlxuICAgKi9cbiAgbGFuZ3VhZ2U/OiBtb25hY28uZWRpdG9yLklTdGFuZGFsb25lRWRpdG9yQ29uc3RydWN0aW9uT3B0aW9uc1snbGFuZ3VhZ2UnXTtcbiAgLyoqXG4gICAqIFVzZXIgcHJvdmlkZWQgZXh0ZW5zaW9uIGZ1bmN0aW9uIHByb3ZpZGVyIGZvciBhdXRvLWNvbXBsZXRlLlxuICAgKi9cbiAgYXV0b0NvbXBsZXRlPzogKG1vZGVsOiBtb25hY28uZWRpdG9yLklUZXh0TW9kZWwsIHBvc2l0aW9uOiBtb25hY28uUG9zaXRpb24pID0+IGxhbmd1YWdlcy5Db21wbGV0aW9uSXRlbVtdO1xuICAvKipcbiAgICogSW5pdGlhbCB0aGVtZSB0byBiZSB1c2VkIGZvciByZW5kZXJpbmcuXG4gICAqIFRoZSBjdXJyZW50IG91dC1vZi10aGUtYm94IGF2YWlsYWJsZSB0aGVtZXMgYXJlOiAndnMnIChkZWZhdWx0KSwgJ3ZzLWRhcmsnLCAnaGMtYmxhY2snLlxuICAgKiBZb3UgY2FuIGNyZWF0ZSBjdXN0b20gdGhlbWVzIHZpYSBgbW9uYWNvLmVkaXRvci5kZWZpbmVUaGVtZWAuXG4gICAqIFRvIHN3aXRjaCBhIHRoZW1lLCB1c2UgYG1vbmFjby5lZGl0b3Iuc2V0VGhlbWVgXG4gICAqL1xuICB0aGVtZT86IG1vbmFjby5lZGl0b3IuSVN0YW5kYWxvbmVFZGl0b3JDb25zdHJ1Y3Rpb25PcHRpb25zWyd0aGVtZSddO1xuICAvKipcbiAgICogVGhlIG9wdGlvbnMgdG8gY3JlYXRlIGFuIGVkaXRvci5cbiAgICovXG4gIG9wdGlvbnM/OiBtb25hY28uZWRpdG9yLklTdGFuZGFsb25lRWRpdG9yQ29uc3RydWN0aW9uT3B0aW9ucztcbiAgLyoqXG4gICAqIGFuIGV2ZW50IGVtaXR0ZWQgd2hlbiB0aGUgZWRpdG9yIGhhcyBiZWVuIG1vdW50ZWQgKHNpbWlsYXIgdG8gYGNvbXBvbmVudERpZE1vdW50YCBvZiBSZWFjdClcbiAgICovXG4gIGVkaXRvckRpZE1vdW50PzogKGVkaXRvcjogbW9uYWNvLmVkaXRvci5JU3RhbmRhbG9uZUNvZGVFZGl0b3IsIG1vbmFjbzogSU1vbmFjb0VkaXRvcikgPT4gdm9pZDtcbiAgLyoqXG4gICAqIGFuIGV2ZW50IGVtaXR0ZWQgd2hlbiB0aGUgY29udGVudCBvZiB0aGUgY3VycmVudCBtb2RlbCBoYXMgY2hhbmdlZC5cbiAgICovXG4gIG9uQ2hhbmdlPzogKHZhbHVlOiBzdHJpbmcsIGV2ZW50OiBtb25hY28uZWRpdG9yLklNb2RlbENvbnRlbnRDaGFuZ2VkRXZlbnQpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVmRWRpdG9ySW5zdGFuY2Uge1xuICBjb250YWluZXI6IEhUTUxEaXZFbGVtZW50IHwgbnVsbDtcbiAgZWRpdG9yPzogbW9uYWNvLmVkaXRvci5JU3RhbmRhbG9uZUNvZGVFZGl0b3I7XG4gIG1vbmFjbzogSU1vbmFjb0VkaXRvcjtcbn1cblxuZnVuY3Rpb24gTW9uYWNvRWRpdG9yKHByb3BzOiBNb25hY29FZGl0b3JQcm9wcywgcmVmOiAoKGluc3RhbmNlOiBSZWZFZGl0b3JJbnN0YW5jZSkgPT4gdm9pZCkgfCBSZWFjdC5SZWZPYmplY3Q8UmVmRWRpdG9ySW5zdGFuY2U+IHwgbnVsbCB8IHVuZGVmaW5lZCkge1xuICBjb25zdCB7IHdpZHRoID0gJzEwMCUnLCBoZWlnaHQgPSAnMTAwJScsIHZhbHVlID0gJycsIHRoZW1lID0gJycsIGxhbmd1YWdlID0gJ2phdmFzY3JpcHQnLCBhdXRvQ29tcGxldGUsIG9wdGlvbnMgPSB7fSwgZWRpdG9yRGlkTW91bnQgPSBub29wLCBvbkNoYW5nZSA9IG5vb3AsIGRlZmF1bHRWYWx1ZSA9ICcnLCAuLi5vdGhlciB9ID0gcHJvcHM7XG4gIG9wdGlvbnMubGFuZ3VhZ2UgPSBsYW5ndWFnZSB8fCBvcHRpb25zLmxhbmd1YWdlO1xuICBvcHRpb25zLnRoZW1lID0gdGhlbWUgfHwgb3B0aW9ucy50aGVtZTtcbiAgY29uc3QgW3ZhbCwgc2V0VmFsXSA9IHVzZVN0YXRlKGRlZmF1bHRWYWx1ZSk7XG4gIGNvbnN0IGNvbnRhaW5lciA9IHVzZVJlZjxIVE1MRGl2RWxlbWVudD4obnVsbCk7XG4gIGNvbnN0IGVkaXRvciA9IHVzZVJlZjxtb25hY28uZWRpdG9yLklTdGFuZGFsb25lQ29kZUVkaXRvcj4oKTtcbiAgdXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsICgpID0+ICh7IGNvbnRhaW5lcjogY29udGFpbmVyLmN1cnJlbnQsIGVkaXRvcjogZWRpdG9yLmN1cnJlbnQsIG1vbmFjbyB9KSk7XG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGNvbnRhaW5lci5jdXJyZW50KSB7XG4gICAgICBlZGl0b3IuY3VycmVudCA9IG1vbmFjby5lZGl0b3IuY3JlYXRlKGNvbnRhaW5lci5jdXJyZW50LCB7XG4gICAgICAgIHZhbHVlOiB2YWwsXG4gICAgICAgIGxhbmd1YWdlLFxuICAgICAgICAuLi5vcHRpb25zLFxuICAgICAgfSk7XG4gICAgICBpZiAob3B0aW9ucy50aGVtZSkge1xuICAgICAgICBtb25hY28uZWRpdG9yLnNldFRoZW1lKG9wdGlvbnMudGhlbWUpO1xuICAgICAgfVxuICAgICAgLy8gQWZ0ZXIgaW5pdGlhbGl6aW5nIG1vbmFjbyBlZGl0b3JcbiAgICAgIGVkaXRvckRpZE1vdW50IShlZGl0b3IuY3VycmVudCwgbW9uYWNvKTtcbiAgICAgIGVkaXRvci5jdXJyZW50Lm9uRGlkQ2hhbmdlTW9kZWxDb250ZW50KChldmVudCkgPT4ge1xuICAgICAgICBjb25zdCB2YWx1ZUN1cnJlbnQgPSBlZGl0b3IuY3VycmVudCEuZ2V0VmFsdWUoKTtcbiAgICAgICAgLy8gQWx3YXlzIHJlZmVyIHRvIHRoZSBsYXRlc3QgdmFsdWVcbiAgICAgICAgb25DaGFuZ2UhKHZhbHVlQ3VycmVudCwgZXZlbnQpO1xuICAgICAgfSk7XG4gICAgfVxuICB9LCBbXSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAodmFsdWUgIT09IHZhbCAmJiBlZGl0b3IuY3VycmVudCkge1xuICAgICAgaWYgKGF1dG9Db21wbGV0ZSkge1xuICAgICAgICBpZiAoZWRpdG9yPy5jdXJyZW50Py5nZXRNb2RlbCgpICYmIGVkaXRvcj8uY3VycmVudD8uZ2V0UG9zaXRpb24oKSkge1xuICAgICAgICAgIG1vbmFjby5sYW5ndWFnZXMucmVnaXN0ZXJDb21wbGV0aW9uSXRlbVByb3ZpZGVyKGxhbmd1YWdlLCB7XG4gICAgICAgICAgICBwcm92aWRlQ29tcGxldGlvbkl0ZW1zOiAobW9kZWwsIHBvc2l0aW9uKSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgc3VnZ2VzdGlvbnM6IGF1dG9Db21wbGV0ZShtb2RlbCwgcG9zaXRpb24pXG4gICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgc2V0VmFsKHZhbHVlKTtcbiAgICAgIGVkaXRvci5jdXJyZW50LnNldFZhbHVlKHZhbHVlKTtcbiAgICB9XG4gIH0sIFt2YWx1ZV0pO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGVkaXRvci5jdXJyZW50KSB7XG4gICAgICBjb25zdCBtb2RlbCA9IGVkaXRvci5jdXJyZW50LmdldE1vZGVsKCk7XG4gICAgICBpZiAobW9kZWwpIHtcbiAgICAgICAgbW9uYWNvLmVkaXRvci5zZXRNb2RlbExhbmd1YWdlKG1vZGVsLCBwcm9wcy5sYW5ndWFnZSB8fCAnJyk7XG4gICAgICB9XG4gICAgfVxuICB9LCBbbGFuZ3VhZ2VdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmIChlZGl0b3IuY3VycmVudCkge1xuICAgICAgY29uc3Qgb3B0aW9uc1JhdyA9IGVkaXRvci5jdXJyZW50LmdldFJhd09wdGlvbnMoKTtcbiAgICAgIDsoT2JqZWN0LmtleXMob3B0aW9uc1JhdykgYXMgKGtleW9mIGVkaXRvci5JRWRpdG9yT3B0aW9ucylbXSkuZm9yRWFjaCgoa2V5bmFtZSkgPT4ge1xuICAgICAgICBjb25zdCBwcm9wc09wdCA9IG9wdGlvbnNba2V5bmFtZV07XG4gICAgICAgIGlmIChvcHRpb25zUmF3W2tleW5hbWVdICE9PSBwcm9wc09wdCAmJiBwcm9wc09wdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgZWRpdG9yLmN1cnJlbnQhLnVwZGF0ZU9wdGlvbnMoeyBba2V5bmFtZV06IHByb3BzT3B0IH0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH0sIFtvcHRpb25zXSk7XG5cbiAgcmV0dXJuIDxkaXYgey4uLm90aGVyfSByZWY9e2NvbnRhaW5lcn0gc3R5bGU9e3sgLi4ub3RoZXIuc3R5bGUsIHdpZHRoLCBoZWlnaHQgfX0gLz47XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlYWN0LmZvcndhcmRSZWY8UmVmRWRpdG9ySW5zdGFuY2UsIE1vbmFjb0VkaXRvclByb3BzPihNb25hY29FZGl0b3IpOyJdfQ==