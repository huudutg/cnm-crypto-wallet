"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var monaco = _interopRequireWildcard(require("monaco-editor"));

function noop() {}

function MonacoEditor(props, ref) {
  var _props$width = props.width,
      width = _props$width === void 0 ? '100%' : _props$width,
      _props$height = props.height,
      height = _props$height === void 0 ? '100%' : _props$height,
      _props$value = props.value,
      value = _props$value === void 0 ? '' : _props$value,
      _props$theme = props.theme,
      theme = _props$theme === void 0 ? '' : _props$theme,
      _props$language = props.language,
      language = _props$language === void 0 ? 'javascript' : _props$language,
      autoComplete = props.autoComplete,
      _props$options = props.options,
      options = _props$options === void 0 ? {} : _props$options,
      _props$editorDidMount = props.editorDidMount,
      editorDidMount = _props$editorDidMount === void 0 ? noop : _props$editorDidMount,
      _props$onChange = props.onChange,
      onChange = _props$onChange === void 0 ? noop : _props$onChange,
      _props$defaultValue = props.defaultValue,
      defaultValue = _props$defaultValue === void 0 ? '' : _props$defaultValue,
      other = (0, _objectWithoutProperties2.default)(props, ["width", "height", "value", "theme", "language", "autoComplete", "options", "editorDidMount", "onChange", "defaultValue"]);
  options.language = language || options.language;
  options.theme = theme || options.theme;

  var _useState = (0, _react.useState)(defaultValue),
      _useState2 = (0, _slicedToArray2.default)(_useState, 2),
      val = _useState2[0],
      setVal = _useState2[1];

  var container = (0, _react.useRef)(null);
  var editor = (0, _react.useRef)();
  (0, _react.useImperativeHandle)(ref, function () {
    return {
      container: container.current,
      editor: editor.current,
      monaco: monaco
    };
  });
  (0, _react.useEffect)(function () {
    if (container.current) {
      editor.current = monaco.editor.create(container.current, (0, _objectSpread2.default)({
        value: val,
        language: language
      }, options));

      if (options.theme) {
        monaco.editor.setTheme(options.theme);
      } // After initializing monaco editor


      editorDidMount(editor.current, monaco);
      editor.current.onDidChangeModelContent(function (event) {
        var valueCurrent = editor.current.getValue(); // Always refer to the latest value

        onChange(valueCurrent, event);
      });
    }
  }, []);
  (0, _react.useEffect)(function () {
    if (value !== val && editor.current) {
      if (autoComplete) {
        var _editor$current, _editor$current2;

        if (editor !== null && editor !== void 0 && (_editor$current = editor.current) !== null && _editor$current !== void 0 && _editor$current.getModel() && editor !== null && editor !== void 0 && (_editor$current2 = editor.current) !== null && _editor$current2 !== void 0 && _editor$current2.getPosition()) {
          monaco.languages.registerCompletionItemProvider(language, {
            provideCompletionItems: function provideCompletionItems(model, position) {
              return {
                suggestions: autoComplete(model, position)
              };
            }
          });
        }
      }

      setVal(value);
      editor.current.setValue(value);
    }
  }, [value]);
  (0, _react.useEffect)(function () {
    if (editor.current) {
      var _model = editor.current.getModel();

      if (_model) {
        monaco.editor.setModelLanguage(_model, props.language || '');
      }
    }
  }, [language]);
  (0, _react.useEffect)(function () {
    if (editor.current) {
      var optionsRaw = editor.current.getRawOptions();
      ;
      Object.keys(optionsRaw).forEach(function (keyname) {
        var propsOpt = options[keyname];

        if (optionsRaw[keyname] !== propsOpt && propsOpt !== undefined) {
          editor.current.updateOptions((0, _defineProperty2.default)({}, keyname, propsOpt));
        }
      });
    }
  }, [options]);
  return /*#__PURE__*/_react.default.createElement("div", (0, _extends2.default)({}, other, {
    ref: container,
    style: (0, _objectSpread2.default)((0, _objectSpread2.default)({}, other.style), {}, {
      width: width,
      height: height
    })
  }));
}

var _default = /*#__PURE__*/_react.default.forwardRef(MonacoEditor);

exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC50c3giXSwibmFtZXMiOlsibm9vcCIsIk1vbmFjb0VkaXRvciIsInByb3BzIiwicmVmIiwid2lkdGgiLCJoZWlnaHQiLCJ2YWx1ZSIsInRoZW1lIiwibGFuZ3VhZ2UiLCJhdXRvQ29tcGxldGUiLCJvcHRpb25zIiwiZWRpdG9yRGlkTW91bnQiLCJvbkNoYW5nZSIsImRlZmF1bHRWYWx1ZSIsIm90aGVyIiwidmFsIiwic2V0VmFsIiwiY29udGFpbmVyIiwiZWRpdG9yIiwiY3VycmVudCIsIm1vbmFjbyIsImNyZWF0ZSIsInNldFRoZW1lIiwib25EaWRDaGFuZ2VNb2RlbENvbnRlbnQiLCJldmVudCIsInZhbHVlQ3VycmVudCIsImdldFZhbHVlIiwiZ2V0TW9kZWwiLCJnZXRQb3NpdGlvbiIsImxhbmd1YWdlcyIsInJlZ2lzdGVyQ29tcGxldGlvbkl0ZW1Qcm92aWRlciIsInByb3ZpZGVDb21wbGV0aW9uSXRlbXMiLCJtb2RlbCIsInBvc2l0aW9uIiwic3VnZ2VzdGlvbnMiLCJzZXRWYWx1ZSIsInNldE1vZGVsTGFuZ3VhZ2UiLCJvcHRpb25zUmF3IiwiZ2V0UmF3T3B0aW9ucyIsIk9iamVjdCIsImtleXMiLCJmb3JFYWNoIiwia2V5bmFtZSIsInByb3BzT3B0IiwidW5kZWZpbmVkIiwidXBkYXRlT3B0aW9ucyIsInN0eWxlIiwiUmVhY3QiLCJmb3J3YXJkUmVmIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFHQSxTQUFTQSxJQUFULEdBQWdCLENBQUU7O0FBMERsQixTQUFTQyxZQUFULENBQXNCQyxLQUF0QixFQUFnREMsR0FBaEQsRUFBc0o7QUFBQSxxQkFDMENELEtBRDFDLENBQzVJRSxLQUQ0STtBQUFBLE1BQzVJQSxLQUQ0SSw2QkFDcEksTUFEb0k7QUFBQSxzQkFDMENGLEtBRDFDLENBQzVIRyxNQUQ0SDtBQUFBLE1BQzVIQSxNQUQ0SCw4QkFDbkgsTUFEbUg7QUFBQSxxQkFDMENI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QUFyRCxFQUFnRTtBQUM5RDFCLFVBQUFBLE1BQU0sQ0FBQ0MsT0FBUCxDQUFnQjBCLGFBQWhCLG1DQUFpQ0gsT0FBakMsRUFBMkNDLFFBQTNDO0FBQ0Q7QUFDRixPQUxBO0FBTUY7QUFDRixHQVZELEVBVUcsQ0FBQ2pDLE9BQUQsQ0FWSDtBQVlBLHNCQUFPLCtEQUFTSSxLQUFUO0FBQWdCLElBQUEsR0FBRyxFQUFFRyxTQUFyQjtBQUFnQyxJQUFBLEtBQUssOERBQU9ILEtBQUssQ0FBQ2dDLEtBQWI7QUFBb0IxQyxNQUFBQSxLQUFLLEVBQUxBLEtBQXBCO0FBQTJCQyxNQUFBQSxNQUFNLEVBQU5BO0FBQTNCO0FBQXJDLEtBQVA7QUFDRDs7NEJBRWMwQyxlQUFNQyxVQUFOLENBQXVEL0MsWUFBdkQsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VJbXBlcmF0aXZlSGFuZGxlLCB1c2VFZmZlY3QsIHVzZVJlZiwgdXNlU3RhdGUgfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgKiBhcyBtb25hY28gZnJvbSAnbW9uYWNvLWVkaXRvcic7XG5pbXBvcnQge2VkaXRvciwgbGFuZ3VhZ2VzfSBmcm9tICdtb25hY28tZWRpdG9yJztcblxuZnVuY3Rpb24gbm9vcCgpIHt9XG5cbmV4cG9ydCB0eXBlIElNb25hY29FZGl0b3IgPSB0eXBlb2YgbW9uYWNvO1xuZXhwb3J0IGludGVyZmFjZSBNb25hY29FZGl0b3JQcm9wcyBleHRlbmRzIE9taXQ8UmVhY3QuSFRNTEF0dHJpYnV0ZXM8SFRNTERpdkVsZW1lbnQ+LCAnb25DaGFuZ2UnPntcbiAgLyoqXG4gICAqIHdpZHRoIG9mIGVkaXRvci5cbiAgICogRGVmYXVsdHMgdG8gYDEwMCVgXG4gICAqL1xuICB3aWR0aD86IG51bWJlciB8IHN0cmluZztcbiAgLyoqXG4gICAqIGhlaWdodCBvZiBlZGl0b3IuXG4gICAqIERlZmF1bHRzIHRvIGAxMDAlYC5cbiAgICovXG4gIGhlaWdodD86IG51bWJlciB8IHN0cmluZztcbiAgLyoqXG4gICAqIHZhbHVlIG9mIHRoZSBhdXRvIGNyZWF0ZWQgbW9kZWwgaW4gdGhlIGVkaXRvci5cbiAgICovXG4gIHZhbHVlPzogc3RyaW5nO1xuICAvKipcbiAgICogdGhlIGluaXRpYWwgdmFsdWUgb2YgdGhlIGF1dG8gY3JlYXRlZCBtb2RlbCBpbiB0aGUgZWRpdG9yLlxuICAgKi9cbiAgZGVmYXVsdFZhbHVlPzogc3RyaW5nO1xuICAvKipcbiAgICogVGhlIGluaXRpYWwgbGFuZ3VhZ2Ugb2YgdGhlIGF1dG8gY3JlYXRlZCBtb2RlbCBpbiB0aGUgZWRpdG9yLlxuICAgKiBUbyBub3QgY3JlYXRlIGF1dG9tYXRpY2FsbHkgYSBtb2RlbCwgdXNlIGBtb2RlbDogbnVsbGAuXG4gICAqL1xuICBsYW5ndWFnZT86IG1vbmFjby5lZGl0b3IuSVN0YW5kYWxvbmVFZGl0b3JDb25zdHJ1Y3Rpb25PcHRpb25zWydsYW5ndWFnZSddO1xuICAvKipcbiAgICogVXNlciBwcm92aWRlZCBleHRlbnNpb24gZnVuY3Rpb24gcHJvdmlkZXIgZm9yIGF1dG8tY29tcGxldGUuXG4gICAqL1xuICBhdXRvQ29tcGxldGU/OiAobW9kZWw6IG1vbmFjby5lZGl0b3IuSVRleHRNb2RlbCwgcG9zaXRpb246IG1vbmFjby5Qb3NpdGlvbikgPT4gbGFuZ3VhZ2VzLkNvbXBsZXRpb25JdGVtW107XG4gIC8qKlxuICAgKiBJbml0aWFsIHRoZW1lIHRvIGJlIHVzZWQgZm9yIHJlbmRlcmluZy5cbiAgICogVGhlIGN1cnJlbnQgb3V0LW9mLXRoZS1ib3ggYXZhaWxhYmxlIHRoZW1lcyBhcmU6ICd2cycgKGRlZmF1bHQpLCAndnMtZGFyaycsICdoYy1ibGFjaycuXG4gICAqIFlvdSBjYW4gY3JlYXRlIGN1c3RvbSB0aGVtZXMgdmlhIGBtb25hY28uZWRpdG9yLmRlZmluZVRoZW1lYC5cbiAgICogVG8gc3dpdGNoIGEgdGhlbWUsIHVzZSBgbW9uYWNvLmVkaXRvci5zZXRUaGVtZWBcbiAgICovXG4gIHRoZW1lPzogbW9uYWNvLmVkaXRvci5JU3RhbmRhbG9uZUVkaXRvckNvbnN0cnVjdGlvbk9wdGlvbnNbJ3RoZW1lJ107XG4gIC8qKlxuICAgKiBUaGUgb3B0aW9ucyB0byBjcmVhdGUgYW4gZWRpdG9yLlxuICAgKi9cbiAgb3B0aW9ucz86IG1vbmFjby5lZGl0b3IuSVN0YW5kYWxvbmVFZGl0b3JDb25zdHJ1Y3Rpb25PcHRpb25zO1xuICAvKipcbiAgICogYW4gZXZlbnQgZW1pdHRlZCB3aGVuIHRoZSBlZGl0b3IgaGFzIGJlZW4gbW91bnRlZCAoc2ltaWxhciB0byBgY29tcG9uZW50RGlkTW91bnRgIG9mIFJlYWN0KVxuICAgKi9cbiAgZWRpdG9yRGlkTW91bnQ/OiAoZWRpdG9yOiBtb25hY28uZWRpdG9yLklTdGFuZGFsb25lQ29kZUVkaXRvciwgbW9uYWNvOiBJTW9uYWNvRWRpdG9yKSA9PiB2b2lkO1xuICAvKipcbiAgICogYW4gZXZlbnQgZW1pdHRlZCB3aGVuIHRoZSBjb250ZW50IG9mIHRoZSBjdXJyZW50IG1vZGVsIGhhcyBjaGFuZ2VkLlxuICAgKi9cbiAgb25DaGFuZ2U/OiAodmFsdWU6IHN0cmluZywgZXZlbnQ6IG1vbmFjby5lZGl0b3IuSU1vZGVsQ29udGVudENoYW5nZWRFdmVudCkgPT4gdm9pZDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWZFZGl0b3JJbnN0YW5jZSB7XG4gIGNvbnRhaW5lcjogSFRNTERpdkVsZW1lbnQgfCBudWxsO1xuICBlZGl0b3I/OiBtb25hY28uZWRpdG9yLklTdGFuZGFsb25lQ29kZUVkaXRvcjtcbiAgbW9uYWNvOiBJTW9uYWNvRWRpdG9yO1xufVxuXG5mdW5jdGlvbiBNb25hY29FZGl0b3IocHJvcHM6IE1vbmFjb0VkaXRvclByb3BzLCByZWY6ICgoaW5zdGFuY2U6IFJlZkVkaXRvckluc3RhbmNlKSA9PiB2b2lkKSB8IFJlYWN0LlJlZk9iamVjdDxSZWZFZGl0b3JJbnN0YW5jZT4gfCBudWxsIHwgdW5kZWZpbmVkKSB7XG4gIGNvbnN0IHsgd2lkdGggPSAnMTAwJScsIGhlaWdodCA9ICcxMDAlJywgdmFsdWUgPSAnJywgdGhlbWUgPSAnJywgbGFuZ3VhZ2UgPSAnamF2YXNjcmlwdCcsIGF1dG9Db21wbGV0ZSwgb3B0aW9ucyA9IHt9LCBlZGl0b3JEaWRNb3VudCA9IG5vb3AsIG9uQ2hhbmdlID0gbm9vcCwgZGVmYXVsdFZhbHVlID0gJycsIC4uLm90aGVyIH0gPSBwcm9wcztcbiAgb3B0aW9ucy5sYW5ndWFnZSA9IGxhbmd1YWdlIHx8IG9wdGlvbnMubGFuZ3VhZ2U7XG4gIG9wdGlvbnMudGhlbWUgPSB0aGVtZSB8fCBvcHRpb25zLnRoZW1lO1xuICBjb25zdCBbdmFsLCBzZXRWYWxdID0gdXNlU3RhdGUoZGVmYXVsdFZhbHVlKTtcbiAgY29uc3QgY29udGFpbmVyID0gdXNlUmVmPEhUTUxEaXZFbGVtZW50PihudWxsKTtcbiAgY29uc3QgZWRpdG9yID0gdXNlUmVmPG1vbmFjby5lZGl0b3IuSVN0YW5kYWxvbmVDb2RlRWRpdG9yPigpO1xuICB1c2VJbXBlcmF0aXZlSGFuZGxlKHJlZiwgKCkgPT4gKHsgY29udGFpbmVyOiBjb250YWluZXIuY3VycmVudCwgZWRpdG9yOiBlZGl0b3IuY3VycmVudCwgbW9uYWNvIH0pKTtcbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoY29udGFpbmVyLmN1cnJlbnQpIHtcbiAgICAgIGVkaXRvci5jdXJyZW50ID0gbW9uYWNvLmVkaXRvci5jcmVhdGUoY29udGFpbmVyLmN1cnJlbnQsIHtcbiAgICAgICAgdmFsdWU6IHZhbCxcbiAgICAgICAgbGFuZ3VhZ2UsXG4gICAgICAgIC4uLm9wdGlvbnMsXG4gICAgICB9KTtcbiAgICAgIGlmIChvcHRpb25zLnRoZW1lKSB7XG4gICAgICAgIG1vbmFjby5lZGl0b3Iuc2V0VGhlbWUob3B0aW9ucy50aGVtZSk7XG4gICAgICB9XG4gICAgICAvLyBBZnRlciBpbml0aWFsaXppbmcgbW9uYWNvIGVkaXRvclxuICAgICAgZWRpdG9yRGlkTW91bnQhKGVkaXRvci5jdXJyZW50LCBtb25hY28pO1xuICAgICAgZWRpdG9yLmN1cnJlbnQub25EaWRDaGFuZ2VNb2RlbENvbnRlbnQoKGV2ZW50KSA9PiB7XG4gICAgICAgIGNvbnN0IHZhbHVlQ3VycmVudCA9IGVkaXRvci5jdXJyZW50IS5nZXRWYWx1ZSgpO1xuICAgICAgICAvLyBBbHdheXMgcmVmZXIgdG8gdGhlIGxhdGVzdCB2YWx1ZVxuICAgICAgICBvbkNoYW5nZSEodmFsdWVDdXJyZW50LCBldmVudCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH0sIFtdKTtcblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmICh2YWx1ZSAhPT0gdmFsICYmIGVkaXRvci5jdXJyZW50KSB7XG4gICAgICBpZiAoYXV0b0NvbXBsZXRlKSB7XG4gICAgICAgIGlmIChlZGl0b3I/LmN1cnJlbnQ/LmdldE1vZGVsKCkgJiYgZWRpdG9yPy5jdXJyZW50Py5nZXRQb3NpdGlvbigpKSB7XG4gICAgICAgICAgbW9uYWNvLmxhbmd1YWdlcy5yZWdpc3RlckNvbXBsZXRpb25JdGVtUHJvdmlkZXIobGFuZ3VhZ2UsIHtcbiAgICAgICAgICAgIHByb3ZpZGVDb21wbGV0aW9uSXRlbXM6IChtb2RlbCwgcG9zaXRpb24pID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBzdWdnZXN0aW9uczogYXV0b0NvbXBsZXRlKG1vZGVsLCBwb3NpdGlvbilcbiAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBzZXRWYWwodmFsdWUpO1xuICAgICAgZWRpdG9yLmN1cnJlbnQuc2V0VmFsdWUodmFsdWUpO1xuICAgIH1cbiAgfSwgW3ZhbHVlXSk7XG5cbiAgdXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoZWRpdG9yLmN1cnJlbnQpIHtcbiAgICAgIGNvbnN0IG1vZGVsID0gZWRpdG9yLmN1cnJlbnQuZ2V0TW9kZWwoKTtcbiAgICAgIGlmIChtb2RlbCkge1xuICAgICAgICBtb25hY28uZWRpdG9yLnNldE1vZGVsTGFuZ3VhZ2UobW9kZWwsIHByb3BzLmxhbmd1YWdlIHx8ICcnKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtsYW5ndWFnZV0pO1xuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKGVkaXRvci5jdXJyZW50KSB7XG4gICAgICBjb25zdCBvcHRpb25zUmF3ID0gZWRpdG9yLmN1cnJlbnQuZ2V0UmF3T3B0aW9ucygpO1xuICAgICAgOyhPYmplY3Qua2V5cyhvcHRpb25zUmF3KSBhcyAoa2V5b2YgZWRpdG9yLklFZGl0b3JPcHRpb25zKVtdKS5mb3JFYWNoKChrZXluYW1lKSA9PiB7XG4gICAgICAgIGNvbnN0IHByb3BzT3B0ID0gb3B0aW9uc1trZXluYW1lXTtcbiAgICAgICAgaWYgKG9wdGlvbnNSYXdba2V5bmFtZV0gIT09IHByb3BzT3B0ICYmIHByb3BzT3B0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICBlZGl0b3IuY3VycmVudCEudXBkYXRlT3B0aW9ucyh7IFtrZXluYW1lXTogcHJvcHNPcHQgfSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfSwgW29wdGlvbnNdKTtcblxuICByZXR1cm4gPGRpdiB7Li4ub3RoZXJ9IHJlZj17Y29udGFpbmVyfSBzdHlsZT17eyAuLi5vdGhlci5zdHlsZSwgd2lkdGgsIGhlaWdodCB9fSAvPjtcbn1cblxuZXhwb3J0IGRlZmF1bHQgUmVhY3QuZm9yd2FyZFJlZjxSZWZFZGl0b3JJbnN0YW5jZSwgTW9uYWNvRWRpdG9yUHJvcHM+KE1vbmFjb0VkaXRvcik7Il19